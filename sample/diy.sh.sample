#!/usr/bin/env bash
## æ­¤æ–‡ä»¶ä¸º DIY è‡ªå®šä¹‰è„šæœ¬æ¨¡æ¿ï¼Œä½ éœ€è¦å¤åˆ¶æ­¤æ–‡ä»¶è‡³ config ç›®å½•å¹¶æ›´åä¸º diy.shï¼ŒåŒæ—¶å¯ç”¨é…ç½®æ–‡ä»¶ä¸­çš„ç›¸å…³å˜é‡åæ‰å¯ä»¥ä½¿ç”¨

## ä½ éœ€è¦å¡«å†™æ­¤è„šæœ¬çš„ä»¥ä¸‹å‡ å¤„åœ°æ–¹ï¼š
## 1. ä½œè€…æ˜µç§°
## 2. ä½œè€…è„šæœ¬åœ°å€é“¾æ¥
## 3. ä½œè€…è„šæœ¬åç§°
## 4. è‡ªå®šä¹‰å‘½ä»¤ï¼ˆé€‰å¡«ï¼‰

## Tips:çœ‹æ¸…æ¥šæ¿å—å’Œå…¶ä¸­çš„æ³¨é‡Šï¼Œä¸è¦ä¹±å†™ä¹±æ”¹

##############################  å®š  ä¹‰  ä»£  ç†  ç›¸  å…³  è®¾  ç½®  ##############################
## æ ¹æ®é…ç½®æ–‡ä»¶ä¸­çš„è®¾ç½®åˆ¤å®šæ˜¯å¦å¯ç”¨äº†ä¸‹è½½ä»£ç†ï¼Œ${ProxyJudge}æ˜¯ä¸€ä¸ªåˆ¤å®šå˜é‡ï¼Œå»ºè®®ä¸è¦ç§»é™¤ï¼Œé…ç½®æ–‡ä»¶ä¸­å¦‚æœæ²¡ç”¨å¯ç”¨è¯¥åˆ¤å®šå˜é‡ä¼šèµ‹å€¼ä¸ºç©º
[[ ${EnableExtraShellProxyDownload} == true ]] && ProxyJudge=${ExtraShellProxyUrl} || ProxyJudge=""

##############################  ä½œ  è€…  æ˜µ  ç§°  &  è„š  æœ¬  åœ°  å€  &  è„š  æœ¬  å  ç§°  ï¼ˆå¿…å¡«ï¼‰  ##############################

author_list=""
## æ·»åŠ æ›´å¤šä½œè€…æ˜µç§°ï¼ˆå¿…å¡«ï¼‰ç¤ºä¾‹ï¼šauthor_list="testuser1 testuser2"  ç›´æ¥è¿½åŠ è¿›åŒå¼•å·å†…ï¼Œä¸è¦æ–°å®šä¹‰å˜é‡ï¼Œå¤šä¸ªå€¼ç”¨ç©ºæ ¼éš”å¼€

scripts_base_url_1=${ProxyJudge}
my_scripts_list_1=""

# å°†ç›¸åº”ä½œè€…çš„è„šæœ¬åœ°å€åˆ°ä»¥ä¸‹å˜é‡ scripts_base_url ä¸­ï¼Œæ³¨æ„å¸¦ä¸Šé¡¹ç›®åˆ†æ”¯åç§°ï¼Œå¦‚æœè„šæœ¬åœ¨æ–‡ä»¶å¤¹ä¸­ä¹Ÿè¦å¸¦ä¸Šæ–‡ä»¶å¤¹åï¼Œä¸è¦å¿˜äº†æœ€åé¢çš„æ–œæ ï¼Œå¹¶ä¸”ä¸€å®šè¦ä½¿ç”¨ raw åœ°å€ï¼ŒGitee åœ°å€éœ€å»é™¤ä¸‹è½½åˆ¤å®šå˜é‡
# å°†ç›¸åº”ä½œè€…çš„è„šæœ¬å¡«å†™åˆ°ä»¥ä¸‹å˜é‡ my_scripts_list ä¸­ï¼Œå¤šä¸ªå€¼ç”¨ç©ºæ ¼éš”å¼€

## ç¤ºä¾‹ï¼šscripts_base_url_2=${ProxyJudge}https://raw.githubusercontent.com/testuser/testrepository/main/
##       my_scripts_list_2="jd_test1.js jd_test2.js jd_test3.js"

##############################  éš  æœº  å‡½  æ•°  ##############################
## ä»¥ä¸‹ä¸ºè„šæœ¬æ ¸å¿ƒå†…å®¹ï¼Œè¯·ä¸è¦éšæ„æ›´æ”¹
rand() {
  min=$1
  max=$(($2 - $min + 1))
  num=$(cat /proc/sys/kernel/random/uuid | cksum | awk -F ' ' '{print $1}')
  echo $(($num % $max + $min))
}
cd ${ShellDir}
index=1
echo -e "\033[33m[*]\033[0m æ‰§è¡Œè‡ªå®šä¹‰è„šæœ¬ğŸ””"
for author in $author_list; do
  echo -e "\n\033[33m[*]\033[0m å¼€å§‹ä¸‹è½½/æ›´æ–° $author çš„æ´»åŠ¨è„šæœ¬:"
  # ä¸‹è½½my_scripts_listä¸­çš„æ¯ä¸ªjsæ–‡ä»¶ï¼Œé‡å‘½åå¢åŠ å‰ç¼€"ä½œè€…æ˜µç§°_"ï¼Œå¢åŠ åç¼€".new"
  eval scripts_list=\$my_scripts_list_${index}
  #echo $scripts_list
  eval url_list=\$scripts_base_url_${index}
  #echo $url_list

  ## åˆ¤æ–­è„šæœ¬æ¥æºä»“åº“
  format_url=$(echo $url_list | awk -F '.com' '{print$NF}' | sed 's/.$//')
  if [[ $(echo $url_list | egrep -o "github|gitee") == "github" ]]; then
    repository_platform="https://github.com"
    repository_branch=$(echo $format_url | awk -F '/' '{print$4}')
    reformat_url=$(echo $format_url | sed "s|$repository_branch|tree/$repository_branch|g")
    if [[ ${EnableExtraShellProxyDownload} == true ]]; then
      DownloadJudgment="é€šè¿‡ä»£ç†"
    else
      DownloadJudgment=""
    fi
  elif [[ $(echo $url_list | egrep -o "github|gitee") == "gitee" ]]; then
    repository_platform="https://gitee.com"
    reformat_url=$(echo $format_url | sed "s|/raw/|/tree/|g")
    DownloadJudgment=""
  fi
  repository_url=$(echo "$repository_platform$reformat_url")
  echo -e "\n\033[33m[*]\033[0m å¼€å§‹${DownloadJudgment}æ›´æ–° $author çš„æ´»åŠ¨è„šæœ¬:"
  echo -e "$repository_url\n"

  for js in $scripts_list; do
    eval url=$url_list$js
    echo $url
    eval name=$js
    wget -q --no-check-certificate $url -O scripts/$name.new

    # å¦‚æœä¸Šä¸€æ­¥ä¸‹è½½æ²¡é—®é¢˜ï¼Œæ‰å»æ‰åç¼€".new"ï¼Œå¦‚æœä¸Šä¸€æ­¥ä¸‹è½½æœ‰é—®é¢˜ï¼Œå°±ä¿ç•™ä¹‹å‰æ­£å¸¸ä¸‹è½½çš„ç‰ˆæœ¬
    # éšæœºæ·»åŠ ä¸ªcronåˆ°crontab.list
    if [ $? -eq 0 ]; then
      mv -f scripts/$name.new scripts/$name
      echo -e "\033[32m[Done]\033[0m $name"

      ## [[ $name == "jd_test.sh" ]] && continue ## ä¸å¯¼å…¥æŸè„šæœ¬çš„å®šæ—¶

      croname=$(echo "$name" | awk -F\. '{print $1}')
      script_date_standard=$(cat ${ScriptsDir}/$name | grep "http" | awk '{if($1~/^[0-59]/) print $1,$2,$3,$4,$5}' | sort | uniq | head -n 1)
      if [[ ${script_date_standard} == "" ]]; then
        script_date=$(cat ${ScriptsDir}/$name | grep "cron" | head -n 1 | sed "s/[a-zA-Z]//g" | awk '{if($1~/^[0-59]/) print $1,$2,$3,$4,$5; else if ($1~/^[*]/) print $2,$3,$4,$5,$6}')
      else
        script_date=${script_date_standard}
      fi
      if [ -z "${script_date}" ]; then
        cron_min=$(rand 1 59)
        cron_hour=$(rand 7 9)
        [ $(grep -c "$croname" ${ListCron}) -eq 0 ] && sed -i "/hangup/a${cron_min} ${cron_hour} * * * bash jd $croname" ${ListCron}
      else
        [ $(grep -c "$croname" ${ListCron}) -eq 0 ] && sed -i "/hangup/a${script_date} bash jd $croname" ${ListCron}
      fi
    else
      [ -f scripts/$name.new ] && rm -f scripts/$name.new
      echo -e "\033[31m[ERROR]\033[0m $name æ›´æ–°å¤±è´¥ï¼Œä½¿ç”¨ä¸Šä¸€æ¬¡æ­£å¸¸çš„ç‰ˆæœ¬\n"
    fi
  done
  echo ''
  index=$(($index + 1))
done
echo -e "\033[32m[Done]\033[0m ç»“æŸğŸ””\n"
##############################  è‡ª  å®š  ä¹‰  å‘½  ä»¤  ï¼ˆé€‰å¡«ï¼‰  ##############################

## åˆ é™¤è„šæœ¬
DeletedScripts="" # å®Œæ•´è„šæœ¬åç§°å¡«å…¥åŒå¼•å·å†…ï¼Œå¤šä¸ªç”¨ç©ºæ ¼éš”å¼€
for del1 in ${DeletedScripts}; do
  [ -f ${ScriptsDir}/$del1 ] && rm -rf ${ScriptsDir}/$del1
done

## åˆ é™¤å®šæ—¶
DeletedCronTask="" # å®šæ—¶ä»»åŠ¡åï¼ˆå®Œæ•´è„šæœ¬åç§°å»æ‰åç¼€æ ¼å¼ï¼‰å¡«å…¥åŒå¼•å·å†…ï¼Œå¤šä¸ªç”¨ç©ºæ ¼éš”å¼€
for del2 in ${DeletedCronTask}; do
  grep -q "$del2" ${ListCron} && sed -i "/$del2/d" ${ListCron}
done
